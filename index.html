<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <link rel="stylesheet" href="css/leaflet.css">
        <link rel="stylesheet" href="css/Control.Geocoder.css">
        <link rel="stylesheet" href="css/qgis2web.css">
        <title>NYS and Surrounding Compost Facilities</title>
    </head>
    <body>
        <div id="map">
        </div>
        <script src="js/leaflet.js"></script>
        <script src="js/leaflet.geocsv.js"></script>
        <script src="js/mustache-4.2.0.min.js"></script>
        <script src="js/Control.Geocoder.js"></script>
        <script>
        var map = L.map('map', {
            renderer: L.canvas(),
            zoomControl:false,
            maxZoom:21,
            minZoom:1,
            zoom: 18
        }).fitBounds([[42.447,-76.480],[42.450,-76.476]]);
        map.attributionControl.setPrefix('');


        // add map title
        var title = new L.Control({'position':'topleft'});
        title.onAdd = function (map) {
            this._div = L.DomUtil.create('div', 'info');
            this.update();
            return this._div;
        };
        title.update = function () {
            this._div.innerHTML = `
            <h2>Cornell Campus Tree Map</h2>
            `;
        };
        title.addTo(map);

        var zoomControl = L.control.zoom({
            position: 'topleft'
        }).addTo(map);

        
        var osmGeocoder = new L.Control.Geocoder({
            geocoder: L.Control.Geocoder.nominatim({geocodingQueryParams: {countrycodes: 'us'}}),
            collapsed: true,
            position: 'topleft'
        }).addTo(map);
        document.getElementsByClassName('leaflet-control-geocoder-icon')[0]
        .title += 'Search for a place';

        map.createPane('pane_HereWegoTerrain_0');
        map.getPane('pane_HereWegoTerrain_0').style.zIndex = 400;
        var layer_HereWegoTerrain_0 = L.tileLayer.wms('https://orthos.its.ny.gov/ArcGIS/services/wms/Latest/MapServer/WMSServer', {
            layers: '2',
            pane: 'pane_HereWegoTerrain_0',
            opacity: 0.7,
            attribution: 'Basemap imagery from <a href="https://gis.ny.gov/orthoimagery">New York State</a>',
            minZoom: 15,
            maxZoom: 21,
            minNativeZoom: 15,
            maxNativeZoom: 21
        });
        map.addLayer(layer_HereWegoTerrain_0);
        
        var bounds_group = new L.featureGroup([])

        let compost_tooltip_template = `
<h3>{{common}}</h3>
<i>{{botanic}}</i><br>
Trunk diameter: {{dbh}} inches<br> ({{yearinv}})
`
        let gcolor = {
            'acer':        '#a6cee3',
            'quercus':     '#1f78b4',
            'pinus':       '#b2df8a',
            'picea':       '#33a02c',
            'malus':       '#fb9a99',
            'cornus':      '#e31a1c',
            'amelanchier': '#fdbf6f',
            'cercis':      '#ff7f00',
            'gleditsia':   '#cab2d6',
            'platanus':    '#6a3d9a',
            'prunus':      '#ffff99',
            'thuja':       '#b15928'
        }
        function style_compost_facility_survey_responses_1_2_0(feature) {
            let c = '#000'
            let genus = feature.properties['botanic'].split(' ')[0].toLowerCase()
            if (gcolor[genus]) {
                c = gcolor[genus]
            }
            return {
                pane: 'pane_compost_facility_survey_responses_1_2',
                radius: Math.pow(feature.properties['dbh'], 0.6) + 3,
                opacity: 1,
                color: '#000',
                fillColor: c,
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.5,
                fill: true,
                fillOpacity: 1
            }
        }
        map.createPane('pane_compost_facility_survey_responses_1_2');
        map.getPane('pane_compost_facility_survey_responses_1_2').style.zIndex = 402;
        map.getPane('pane_compost_facility_survey_responses_1_2').style['mix-blend-mode'] = 'normal';

        let gs_layer

        loadCSV();

        function loadCSV() {
          url = 'data/trees.csv'
          fetch(url)
            .then((response) => {
              if (response.ok) response.text().then((csvtext) => {
                // L.geoCsv won't see the last record without a final newline
                csvtext += '\n'
                gs_layer = L.geoCsv(csvtext, {
                  attribution: 'Tree data from <a href="https://cugir.library.cornell.edu/catalog/cugir-009100">CUGIR</a>',
                  firstLineTitles: true,
                  fieldSeparator: ',',
                  latitudeTitle: 'y',
                  longitudeTitle: 'x',
                  pointToLayer: function(feature, latlng) {
                    let tooltip = Mustache.render(compost_tooltip_template, feature.properties)
                    return L.circleMarker(latlng, style_compost_facility_survey_responses_1_2_0(feature))
                      .bindTooltip(tooltip, {
                        direction: 'top',
                        offset: L.point(0, -8),
                        opacity: 1.0
                      })
                      .on('mouseover', function () {
                        this.move
                        this.setStyle({
                            color: '#fff'
                        })
                      })
                      .on('mouseout', function () {
                        this.setStyle({
                            color: '#000'
                        })
                      })
                  }
                })
                map.addLayer(gs_layer)
                map.fitBounds(bounds_group.getBounds())
              })
              else {
                console.log(response)
              }
            })
        }

        map.on('tooltipopen', (e) => {
            console.log(e)
        })
        map.on('tooltipclose', (e) => {
            console.log(e.target, 'closed')
        })
        </script>
    </body>
</html>
